name: Pipe 3 - Release/x.y.z -> Main (tag on merge)

on:
  pull_request:
    branches:
      - "main"
    types: [closed]

permissions:
  contents: write

concurrency:
  group: pipe3-main-tag
  cancel-in-progress: true

jobs:
  tag:
    name: Generate tag vX.Y.Z on merge of release/x.y.z
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Validate release branch + extract version
        id: v
        shell: bash
        run: |
          set -euo pipefail
          head_ref="${{ github.event.pull_request.head.ref }}"
          sha="${{ github.event.pull_request.merge_commit_sha }}"

          echo "Merged PR head ref: $head_ref"
          echo "Merge commit sha: $sha"

          if [[ ! "$head_ref" =~ ^release/([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            echo "Not a release/x.y.z PR. Skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          version="${BASH_REMATCH[1]}"
          tag="v${version}"

          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "sha=$sha" >> "$GITHUB_OUTPUT"

      - name: Create tag (if missing) pointing to merge commit
        if: steps.v.outputs.skip == 'false'
        uses: actions/github-script@v8
        with:
          github-token: ${{ github.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = `${{ steps.v.outputs.tag }}`;
            const sha = `${{ steps.v.outputs.sha }}`;

            // If tag already exists, skip
            try {
              await github.rest.git.getRef({ owner, repo, ref: `tags/${tag}` });
              core.info(`Tag ${tag} already exists. Skipping.`);
              return;
            } catch (e) {
              if (e.status !== 404) throw e;
            }

            // Create lightweight tag ref
            await github.rest.git.createRef({
              owner,
              repo,
              ref: `refs/tags/${tag}`,
              sha,
            });

            core.info(`Created tag ${tag} at ${sha}`);
