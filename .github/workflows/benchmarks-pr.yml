name: Benchmarks (PR)

on:
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch: {}

permissions:
  contents: read
  pull-requests: write

jobs:
  bench:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.26.x"
          cache: true

      - name: Run benchmarks
        id: bench
        shell: bash
        run: |
          set -euo pipefail
          echo "Running benchmarks..."
          go test ./... -bench=. -benchmem | tee bench.txt
          # GitHub step summary
          {
            echo "## Benchmark Results"
            echo ""
            echo "\`\`\`"
            tail -n 200 bench.txt
            echo "\`\`\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Comment on PR (summary)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('bench.txt', 'utf8');
            // Keep comment short to avoid spam; last 200 lines is usually enough.
            const lines = body.split('\n');
            const tail = lines.slice(Math.max(lines.length - 200, 0)).join('\n');
            const comment = [
              '## Benchmarks',
              '',
              '```',
              tail,
              '```',
              '',
              '_Tip: compare allocs/op and ns/op against main branch baseline._'
            ].join('\n');

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;

            await github.rest.issues.createComment({ owner, repo, issue_number, body: comment });
