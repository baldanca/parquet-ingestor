name: Auto PR (feature -> develop)

on:
  push:
    branches:
      - "feat/**"
      - "feature/**"

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: auto-pr-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Verify token
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${{ secrets.AUTO_PR_TOKEN }}" ]]; then
            echo "Missing secret AUTO_PR_TOKEN (PAT)."
            echo "Create a PAT and add it as repo secret AUTO_PR_TOKEN."
            exit 1
          fi

      - name: Create or update PR to develop
        env:
          GH_TOKEN: ${{ secrets.AUTO_PR_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          AUTO_PR_REVIEWERS: ${{ vars.AUTO_PR_REVIEWERS }}
        shell: bash
        run: |
  set -euo pipefail

  if [[ "$BRANCH" != feat/* && "$BRANCH" != feature/* ]]; then
    echo "Not a feature branch: $BRANCH. Skipping."
    exit 0
  fi

  gh api "repos/$REPO/branches/develop" >/dev/null

  title="feat: ${BRANCH} -> develop"

  cat > pr_body.txt <<EOT
This PR was automatically created/maintained by CI.

- Source: ${BRANCH}
- Target: develop

Notes:
- Pushes to this branch keep this PR up to date.
- PR is created as Draft by default; mark Ready when CI is green.
EOT

  existing="$(gh pr list \
    --repo "$REPO" \
    --state open \
    --base develop \
    --head "$BRANCH" \
    --json number \
    --jq '.[0].number // empty')"

  if [[ -n "${existing:-}" ]]; then
    gh pr edit "$existing" \
      --repo "$REPO" \
      --title "$title" \
      --body-file pr_body.txt \
      --add-label "feature" \
      --add-label "auto-pr" \
      --add-assignee "$ACTOR" || true

    exit 0
  fi

  pr_url="$(gh pr create \
    --repo "$REPO" \
    --base develop \
    --head "$BRANCH" \
    --title "$title" \
    --body-file pr_body.txt \
    --draft)"

  echo "Created PR: $pr_url"