name: Auto PR (feature -> develop)

on:
  push:
    branches:
      - "feat/**"
      - "feature/**"

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: auto-pr-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Verify token
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${{ secrets.AUTO_PR_TOKEN }}" ]]; then
            echo "Missing secret AUTO_PR_TOKEN (PAT)."
            echo "Create a PAT and add it as repo secret AUTO_PR_TOKEN."
            exit 1
          fi

      - name: Create or update PR to develop
        env:
          GH_TOKEN: ${{ secrets.AUTO_PR_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          AUTO_PR_REVIEWERS: ${{ vars.AUTO_PR_REVIEWERS }}
        shell: bash
        run: |
          set -euo pipefail

          # Only feature branches (extra safety)
          if [[ "$BRANCH" != feat/* && "$BRANCH" != feature/* ]]; then
            echo "Not a feature branch: $BRANCH. Skipping."
            exit 0
          fi

          # Ensure develop exists
          gh api "repos/$REPO/branches/develop" >/dev/null

          # PR title/body (avoid YAML/encoding issues)
          title="feat: ${BRANCH} -> develop"

          body="$(cat <<EOF
This PR was automatically created/maintained by CI.

- Source: \`${BRANCH}\`
- Target: \`develop\`

Notes:
- Pushes to this branch keep this PR up to date.
- PR is created as Draft by default; mark Ready when CI is green.
EOF
)"

          # Check if an open PR already exists
          existing="$(gh pr list \
            --repo "$REPO" \
            --state open \
            --base develop \
            --head "$BRANCH" \
            --json number \
            --jq '.[0].number // empty')"

          if [[ -n "${existing:-}" ]]; then
            echo "PR exists: #$existing. Updating metadata..."
            gh pr edit "$existing" \
              --repo "$REPO" \
              --title "$title" \
              --body "$body" \
              --add-label "feature" \
              --add-label "auto-pr" \
              --add-assignee "$ACTOR" || true

            # Optional reviewers: repo variable AUTO_PR_REVIEWERS="user1,user2"
            if [[ -n "${AUTO_PR_REVIEWERS:-}" ]]; then
              IFS=',' read -ra reviewers <<< "$AUTO_PR_REVIEWERS"
              for r in "${reviewers[@]}"; do
                rr="$(echo "$r" | xargs)"
                [[ -n "$rr" ]] && gh pr edit "$existing" --repo "$REPO" --add-reviewer "$rr" || true
              done
            fi

            exit 0
          fi

          echo "No PR found. Creating Draft PR..."
          pr_url="$(gh pr create \
            --repo "$REPO" \
            --base develop \
            --head "$BRANCH" \
            --title "$title" \
            --body "$body" \
            --draft)"

          pr_number="$(echo "$pr_url" | awk -F/ '{print $NF}')"

          gh pr edit "$pr_number" \
            --repo "$REPO" \
            --add-label "feature" \
            --add-label "auto-pr" \
            --add-assignee "$ACTOR" || true

          if [[ -n "${AUTO_PR_REVIEWERS:-}" ]]; then
            IFS=',' read -ra reviewers <<< "$AUTO_PR_REVIEWERS"
            for r in "${reviewers[@]}"; do
              rr="$(echo "$r" | xargs)"
              [[ -n "$rr" ]] && gh pr edit "$pr_number" --repo "$REPO" --add-reviewer "$rr" || true
            done
          fi

          echo "Created PR: $pr_url"