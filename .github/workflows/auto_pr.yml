name: Auto PR (feature -> develop)

on:
  push:
    branches:
      - "feat/**"
      - "feature/**"

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: auto-pr-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  auto-pr:

    runs-on: ubuntu-latest

    steps:

      - name: Verify token
        shell: bash
        run: |
          if [[ -z "${{ secrets.AUTO_PR_TOKEN }}" ]]; then
            echo "Missing AUTO_PR_TOKEN secret"
            exit 1
          fi

      - name: Create or update PR
        shell: bash

        env:
          GH_TOKEN: ${{ secrets.AUTO_PR_TOKEN }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}

        run: |
          set -euo pipefail

          echo "Branch: $BRANCH"

          if [[ "$BRANCH" != feat/* && "$BRANCH" != feature/* ]]; then
            echo "Skipping non feature branch"
            exit 0
          fi

          gh api repos/$REPO/branches/develop >/dev/null

          TITLE="feat: ${BRANCH} -> develop"

          cat > pr_body.txt <<EOF
This PR was automatically created by CI.

Source: ${BRANCH}
Target: develop

EOF

          EXISTING=$(gh pr list \
            --repo "$REPO" \
            --state open \
            --base develop \
            --head "$BRANCH" \
            --json number \
            --jq '.[0].number // empty')

          if [[ -n "$EXISTING" ]]; then
            echo "Updating PR #$EXISTING"

            gh pr edit "$EXISTING" \
              --repo "$REPO" \
              --title "$TITLE" \
              --body-file pr_body.txt

            exit 0
          fi

          echo "Creating PR"

          gh pr create \
            --repo "$REPO" \
            --base develop \
            --head "$BRANCH" \
            --title "$TITLE" \
            --body-file pr_body.txt \
            --draft